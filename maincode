#!/usr/bin/env bash

# ------------------------------------------------------------
#   worklog_pomodoro.sh
#   Pomodoro timer â”€ 25â€‘min work / 5â€‘min break loops.
#   Logs to $HOME/.worklog_pomodoro/YYYYâ€‘MMâ€‘DD.csv
#   On stop: prints completed cycles & total focused minutes.
#   Usage : worklog_pomodoro.sh {start|stop|status}
# ------------------------------------------------------------
set -euo pipefail

# --- CONFIG -------------------------------------------------
LOGDIR="$HOME/.worklog_pomodoro"        # â† ä¿å­˜å…ˆ
PIDFILE="$LOGDIR/pid"                  # â† å®Ÿè¡Œä¸­ PID
WORK_SEC=$((25*60))   # ä½œæ¥­ 25 åˆ†ï¼ˆç§’ï¼‰ #ã‚ã¨ã§25ã«å¤‰æ›´
BREAK_SEC=$((5*60))   # ä¼‘æ†©  5 åˆ†ï¼ˆç§’ï¼‰ #ã‚ã¨ã§5ã«å¤‰æ›´
# ------------------------------------------------------------

mkdir -p "$LOGDIR"
LOGFILE="$LOGDIR/$(date +%F).csv"

# 1 è¡Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
msg(){ printf '%s\n' "$*"; }

start() {
  # äºŒé‡èµ·å‹•ãƒã‚§ãƒƒã‚¯
  if [[ -f $PIDFILE ]] && kill -0 "$(<"$PIDFILE")" 2>/dev/null; then
    msg "Already running (PID $(<"$PIDFILE"))."; return 1; fi

  msg "Pomodoro started ğŸš€ (work ${WORK_SEC}s / break ${BREAK_SEC}s)"
  echo "$(date '+%F %T'),SESSION_START" >>"$LOGFILE"

  # ã‚µãƒ–ã‚·ã‚§ãƒ«ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œ
  (
    trap 'rm -f "$PIDFILE"; exit' INT TERM EXIT  # å¾Œç‰‡ä»˜ã‘

    # ã‚µã‚¤ã‚¯ãƒ«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
    cycle_count=1

    while true; do
      # ãã®æ—¥ã®ç´¯ç©ã‚µã‚¤ã‚¯ãƒ«æ•°ã‚’è¨ˆç®—
      total_today=$(grep -c ',WORK_END' "$LOGFILE" 2>/dev/null || echo "0")
      next_cycle=$((total_today + cycle_count))

      echo "$(date '+%F %T'),WORK_START"  >>"$LOGFILE"
      msg "[$(date '+%H:%M')] ğŸ… Cycle ${next_cycle} (Session ${cycle_count}): Work session started!"
      sleep "$WORK_SEC"
      echo "$(date '+%F %T'),WORK_END"    >>"$LOGFILE"
      msg "[$(date '+%H:%M')] âœ… Cycle ${next_cycle} completed â€” take 5â€‘min break!"

      echo "$(date '+%F %T'),BREAK_START" >>"$LOGFILE"
      sleep "$BREAK_SEC"
      echo "$(date '+%F %T'),BREAK_END"   >>"$LOGFILE"
      msg "[$(date '+%H:%M')] â˜• Break over â€” starting next work session!"

      # ã‚µã‚¤ã‚¯ãƒ«å®Œäº†å¾Œã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å¢—åŠ 
      ((cycle_count++))
    done
  ) &
  
  # ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã®PIDã‚’è¨˜éŒ²
  echo $! >"$PIDFILE"
}
stop() {
  if [[ ! -f $PIDFILE ]]; then msg "No active work session."; return; fi

  pid=$(<"$PIDFILE")
  kill "$pid" 2>/dev/null || true
  rm -f "$PIDFILE"
  echo "$(date '+%F %T'),SESSION_END" >>"$LOGFILE"

  cycles=$(grep -c ',WORK_END' "$LOGFILE" || true)
  total_min=$((cycles * 25 ))
  total_hour=$((cycles * 25 / 60 ))
  msg "Completed cycles : $cycles"
  msg "Total focus time : ${total_min} min (${total_hour} hour )"
}

status() {
  if [[ -f $PIDFILE ]] && kill -0 "$(<"$PIDFILE")" 2>/dev/null; then
    msg "Work session running (PID $(<"$PIDFILE")).";
  else
    msg "No active work session."; fi
}

case ${1:-} in
  start)  start  ;;
  stop)   stop   ;;
  status) status ;;
  *) msg "Usage: $0 {start|stop|status}"; exit 1 ;;
 esac
