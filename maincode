#!/usr/bin/env bash

# ------------------------------------------------------------
#   worklog_pomodoro.sh
#   Pomodoro timer â”€ 25â€‘min work / 5â€‘min break loops.
#   Logs to $HOME/.worklog_pomodoro/YYYYâ€‘MMâ€‘DD.csv
#   On stop: prints completed cycles & total focused minutes.
#   Usage : worklog_pomodoro.sh {start|stop|status}
# ------------------------------------------------------------
set -euo pipefail
export TZ='Asia/Tokyo'

# --- CONFIG -------------------------------------------------
LOGDIR="$HOME/.worklog_pomodoro"        # â† ä¿å­˜å…ˆ
PIDFILE="$LOGDIR/pid"                  # â† å®Ÿè¡Œä¸­ PID
WORK_SEC=$((1*60))   # ä½œæ¥­ 25 åˆ†ï¼ˆç§’ï¼‰ #ã‚ã¨ã§25ã«å¤‰æ›´
BREAK_SEC=$((1*60))   # ä¼‘æ†©  5 åˆ†ï¼ˆç§’ï¼‰ #ã‚ã¨ã§5ã«å¤‰æ›´
# ------------------------------------------------------------

mkdir -p "$LOGDIR"
LOGFILE="$LOGDIR/$(date +%F).csv"

# 1 è¡Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
msg(){ printf '%s\n' "$*"; }

# ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—é€šçŸ¥é–¢æ•°
notify() {
  local message="$1"
  osascript -e "display notification \"$message\" with title \"Pomodoro Timer\""
}

start() {
  # äºŒé‡èµ·å‹•ãƒã‚§ãƒƒã‚¯
  if [[ -f $PIDFILE ]] && kill -0 "$(<"$PIDFILE")" 2>/dev/null; then
    msg "Already running (PID $(<"$PIDFILE"))."; return 1; fi

  msg "Pomodoro started ğŸš€ (work $((WORK_SEC/60))min / break $((BREAK_SEC/60))min)"
  notify "Pomodoro started ğŸš€ Work: $((WORK_SEC/60)) min, Break: $((BREAK_SEC/60)) min"
  echo "$(date '+%F %T'),SESSION_START" >>"$LOGFILE"

  # ã‚µãƒ–ã‚·ã‚§ãƒ«ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å®Ÿè¡Œ
  (
    trap 'rm -f "$PIDFILE"; exit' INT TERM EXIT  # å¾Œç‰‡ä»˜ã‘

    # ã‚µã‚¤ã‚¯ãƒ«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
    declare -i cycle_count=1

    while true; do
      # ãã®æ—¥ã®ç´¯ç©ã‚µã‚¤ã‚¯ãƒ«æ•°ã‚’è¨ˆç®—
      total_today=$(grep -c ',WORK_END' "$LOGFILE" 2>/dev/null || echo "0")
      if ! [[ "$total_today" =~ ^[0-9]+$ ]]; then total_today=0; fi
      next_cycle=$((total_today + cycle_count))

      echo "$(date '+%F %T'),WORK_START"  >>"$LOGFILE"
      msg "[$(date '+%H:%M')] ğŸ… Cycle ${next_cycle} (Session ${cycle_count}): Work session started!"
      notify "ğŸ… Cycle ${next_cycle}: Work session started!"
      sleep "$WORK_SEC"

      echo "$(date '+%F %T'),WORK_END"    >>"$LOGFILE"
      msg "[$(date '+%H:%M')] âœ… Cycle ${next_cycle} completed â€” take 5â€‘min break!"
      notify "âœ… Cycle ${next_cycle} completed â€” take a 5â€‘min break!"
      sleep "$BREAK_SEC"

      echo "$(date '+%F %T'),BREAK_END"   >>"$LOGFILE"
      msg "[$(date '+%H:%M')] ğŸ•’ Break over â€” starting next cycle!"
      notify "ğŸ•’ Break over â€” starting next cycle!"
      cycle_count+=1
    done
  ) &
  echo "$!" >"$PIDFILE"
}

stop() {
  if [[ -f $PIDFILE ]] && kill -0 "$(<"$PIDFILE")" 2>/dev/null; then
    kill "$(<"$PIDFILE")" && rm -f "$PIDFILE"
    msg "Pomodoro stopped."
    notify "Pomodoro stopped."
    echo "$(date '+%F %T'),SESSION_STOP" >>"$LOGFILE"
  else
    msg "Pomodoro is not running."
  fi
}

status() {
  if [[ -f $PIDFILE ]] && kill -0 "$(<"$PIDFILE")" 2>/dev/null; then
    msg "Pomodoro is running (PID $(<"$PIDFILE"))."
  else
    msg "Pomodoro is not running."
  fi
}

case "$1" in
  start) start ;;
  stop) stop ;;
  status) status ;;
  *) msg "Usage: $0 {start|stop|status}" ;;
esac
